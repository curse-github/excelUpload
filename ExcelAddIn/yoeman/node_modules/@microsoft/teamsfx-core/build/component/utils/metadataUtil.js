"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.metadataUtil = exports.MetadataUtil = void 0;
const telemetry_1 = require("../../common/telemetry");
const versionMetadata_1 = require("../../common/versionMetadata");
const globalVars_1 = require("../../core/globalVars");
const interface_1 = require("../configManager/interface");
const parser_1 = require("../configManager/parser");
const crypto_1 = require("crypto");
class MetadataUtil {
    async parse(path, env) {
        var _a, _b;
        const res = await parser_1.yamlParser.parse(path, true);
        const props = {};
        props[telemetry_1.TelemetryProperty.YmlName] = (env === "local" ? versionMetadata_1.MetadataV3.localConfigFile : versionMetadata_1.MetadataV3.configFile)
            .split(".")
            .join("");
        if (res.isOk()) {
            for (const name of interface_1.LifecycleNames) {
                const str = (_a = res.value[name]) === null || _a === void 0 ? void 0 : _a.driverDefs.map((def) => def.uses).toString().split("/").join("");
                props[name + ".actions"] = str !== null && str !== void 0 ? str : "";
            }
            props[telemetry_1.TelemetryProperty.YmlSchemaVersion] = res.value.version;
            (_b = globalVars_1.TOOLS.telemetryReporter) === null || _b === void 0 ? void 0 : _b.sendTelemetryEvent(telemetry_1.TelemetryEvent.MetaData, props);
        }
        return res;
    }
    parseManifest(manifest) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p;
        const props = {};
        const prefix = "manifest.";
        props[prefix + "id"] = (_a = manifest.id) !== null && _a !== void 0 ? _a : "";
        props[prefix + "version"] = (_b = manifest.version) !== null && _b !== void 0 ? _b : "";
        props[prefix + "manifestVersion"] = (_c = manifest.manifestVersion) !== null && _c !== void 0 ? _c : "";
        props[prefix + "bots"] = (_e = (_d = manifest.bots) === null || _d === void 0 ? void 0 : _d.map((bot) => bot.botId).toString()) !== null && _e !== void 0 ? _e : "";
        props[prefix + "composeExtensions"] =
            (_g = (_f = manifest.composeExtensions) === null || _f === void 0 ? void 0 : _f.map((bot) => bot.botId).toString()) !== null && _g !== void 0 ? _g : "";
        props[prefix + "staticTabs.contentUrl"] =
            (_j = (_h = manifest.staticTabs) === null || _h === void 0 ? void 0 : _h.map((tab) => tab.contentUrl
                ? crypto_1.createHash("sha256").update(tab.contentUrl).digest("base64")
                : "undefined").toString()) !== null && _j !== void 0 ? _j : "";
        props[prefix + "configurableTabs.configurationUrl"] =
            (_l = (_k = manifest.configurableTabs) === null || _k === void 0 ? void 0 : _k.map((tab) => tab.configurationUrl
                ? crypto_1.createHash("sha256").update(tab.configurationUrl).digest("base64")
                : "undefined").toString()) !== null && _l !== void 0 ? _l : "";
        props[prefix + "webApplicationInfo.id"] = (_o = (_m = manifest.webApplicationInfo) === null || _m === void 0 ? void 0 : _m.id) !== null && _o !== void 0 ? _o : "";
        (_p = globalVars_1.TOOLS.telemetryReporter) === null || _p === void 0 ? void 0 : _p.sendTelemetryEvent(telemetry_1.TelemetryEvent.MetaData, props);
    }
}
exports.MetadataUtil = MetadataUtil;
exports.metadataUtil = new MetadataUtil();
//# sourceMappingURL=metadataUtil.js.map